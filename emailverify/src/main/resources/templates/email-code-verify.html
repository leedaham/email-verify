<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ì´ë©”ì¼ ì¸ì¦</title>
    <meta charset="UTF-8">
    <script>
        function sendCode() {
            const email = document.getElementById("email").value;
            if (!email) {
                alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            fetch("/email-code/send", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: `email=${encodeURIComponent(email)}`
            })
            .then(response => {
                if (!response.ok) throw new Error("ì½”ë“œ ì „ì†¡ ì‹¤íŒ¨");
                return response.text();
            })
            .then(msg => {
                alert("ì¸ì¦ ì½”ë“œê°€ ì´ë©”ì¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById("verify-section").style.display = "block";
                startTimer(300); // 5ë¶„
                document.getElementById("message").innerText = "";
            })
            .catch(err => {
                alert("ì¸ì¦ ì½”ë“œ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                console.error(err);
            });
        }

        function verifyCode() {
            const code = document.getElementById("code").value;
            fetch("/email-code/verify", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: `code=${encodeURIComponent(code)}`
            })
            .then(response => response.text().then(text => ({ status: response.status, body: text })))
            .then(({ status, body }) => {
                const msgEl = document.getElementById("message");
                if (status === 200) {
                    msgEl.style.color = "green";
                    msgEl.innerText = "ğŸ‰ ì¸ì¦ ì„±ê³µ!";
                    clearInterval(timerInterval);
                } else {
                    msgEl.style.color = "red";
                    msgEl.innerText = body;
                }
            });
        }

        let timerInterval;
        function startTimer(seconds) {
            clearInterval(timerInterval); // ì¤‘ë³µ ë°©ì§€
            const timerEl = document.getElementById("timer");
            let remaining = seconds;

            timerInterval = setInterval(() => {
                const min = String(Math.floor(remaining / 60)).padStart(2, '0');
                const sec = String(remaining % 60).padStart(2, '0');
                timerEl.textContent = `${min}:${sec}`;

                if (--remaining < 0) {
                    clearInterval(timerInterval);
                    document.getElementById("verify-section").style.display = "none";
                    alert("ì¸ì¦ ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
            }, 1000);
        }
    </script>
</head>
<body>
<h2>ğŸ“§ ì´ë©”ì¼ ì¸ì¦</h2>

<!-- ì´ë©”ì¼ ì…ë ¥ -->
<div>
    <input type="email" id="email" placeholder="ì´ë©”ì¼ ì…ë ¥" required />
    <button onclick="sendCode()">ì¸ì¦ ì½”ë“œ ë³´ë‚´ê¸°</button>
</div>

<!-- ì¸ì¦ ì½”ë“œ ê²€ì¦ -->
<div id="verify-section" style="display:none; margin-top:20px;">
    <p>ğŸ“¬ ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
    <input type="text" id="code" placeholder="ì¸ì¦ ì½”ë“œ" required />
    <button onclick="verifyCode()">í™•ì¸</button>
    <p>â± ë‚¨ì€ ì‹œê°„: <span id="timer">05:00</span></p>
</div>

<!-- ê²°ê³¼ ë©”ì‹œì§€ -->
<p id="message" style="margin-top: 20px;"></p>
</body>
</html>
